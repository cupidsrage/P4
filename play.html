<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phantasia 4 - Multiplayer Browser Mode</title>
  <style>
    :root {
      --bg: #120f1e;
      --panel: #1e1a2f;
      --text: #eee6ff;
      --muted: #b7acce;
      --accent: #a580ff;
      --good: #69db7c;
      --bad: #ff8787;
      --warn: #ffd166;
      --border: #3c335b;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: radial-gradient(circle at top, #221a3a 0%, var(--bg) 55%);
      color: var(--text);
      min-height: 100vh;
      padding: 1.2rem;
    }

    .layout {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 1rem;
    }

    .panel {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(30, 26, 47, 0.94);
      padding: 0.9rem;
    }

    h1, h2, h3 { margin: 0.2rem 0 0.8rem; }
    .muted { color: var(--muted); }
    a { color: #c8b2ff; }

    .join {
      display: grid;
      gap: 0.5rem;
      margin-bottom: 0.8rem;
    }

    input {
      border: 1px solid #5f4f8e;
      border-radius: 8px;
      padding: 0.55rem;
      background: #171326;
      color: var(--text);
    }

    button {
      border: 1px solid #5f4f8e;
      border-radius: 8px;
      background: #2b2342;
      color: #f4eeff;
      font-weight: 600;
      padding: 0.55rem 0.5rem;
      cursor: pointer;
    }

    button:hover:not(:disabled) { background: #3a2f5b; }
    button:disabled { opacity: 0.45; cursor: not-allowed; }

    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-top: 0.9rem;
    }

    .badge {
      display: inline-block;
      padding: 0.15rem 0.45rem;
      border-radius: 99px;
      border: 1px solid var(--border);
      margin-left: 0.4rem;
      font-size: 0.82rem;
    }

    .status-online { color: var(--good); }
    .status-offline { color: var(--bad); }

    .battle, #log, #party {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #171326;
      padding: 0.75rem;
    }

    #log {
      max-height: 285px;
      overflow: auto;
      margin-top: 0.8rem;
      background: #131024;
    }

    #party { margin-top: 0.8rem; }
    .entry { margin: 0 0 0.34rem; }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .actions { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <section class="panel">
      <h1>Phantasia 4: Multiplayer Browser Mode</h1>
      <p class="muted">Room-based co-op battles that run on Railway from a single web URL.</p>

      <div class="join">
        <input id="nameInput" placeholder="Hero name" value="Adventurer" maxlength="24" />
        <input id="roomInput" placeholder="Room name" value="global" maxlength="24" />
        <button id="joinBtn">Join Multiplayer Room</button>
      </div>

      <p>
        Connection:
        <strong id="status" class="status-offline">offline</strong>
        <span id="roomTag" class="badge">not joined</span>
      </p>

      <div class="actions">
        <button id="attackBtn" disabled>âš”ï¸ Attack</button>
        <button id="spellBtn" disabled>âœ¨ Cast Spell (10 Mana)</button>
        <button id="potionBtn" disabled>ğŸ§ª Drink Potion</button>
        <button id="restBtn" disabled>ğŸ›Œ Rest</button>
        <button id="nextBtn" disabled>â¡ï¸ Start Next Encounter</button>
      </div>

      <p class="muted" style="margin-top:0.8rem;">Invite friends into the same room name to play together.</p>
    </section>

    <section class="panel">
      <h2 id="encounterTitle">No active session</h2>
      <div id="battle" class="battle">Join a room to enter the realm.</div>

      <h3>Party</h3>
      <div id="party">No party members.</div>

      <h3>Realm Chronicle</h3>
      <div id="log"></div>

      <p class="muted" style="margin-top:0.75rem;">Back to <a href="index.html">home</a>.</p>
    </section>
  </div>

  <script>
    let eventSource = null;
    let playerId = null;
    let currentRoom = '';
    let currentState = null;

    const ids = (id) => document.getElementById(id);
    const controls = {
      join: ids('joinBtn'),
      attack: ids('attackBtn'),
      spell: ids('spellBtn'),
      potion: ids('potionBtn'),
      rest: ids('restBtn'),
      next: ids('nextBtn')
    };

    function setConnected(connected) {
      const status = ids('status');
      status.textContent = connected ? 'online' : 'offline';
      status.className = connected ? 'status-online' : 'status-offline';
    }

    function me() {
      return currentState?.players?.find((player) => player.id === playerId) || null;
    }

    function setActionAvailability() {
      const player = me();
      const enemy = currentState?.enemy;
      const active = Boolean(player && player.alive);
      controls.attack.disabled = !active || !enemy;
      controls.spell.disabled = !active || !enemy || player.mana < 10;
      controls.potion.disabled = !active || !enemy || player.potions <= 0 || player.hp === player.maxHp;
      controls.rest.disabled = !active || !enemy;
      controls.next.disabled = !active || !!enemy;
    }

    function renderBattle(state) {
      const encounterTitle = ids('encounterTitle');
      const battle = ids('battle');

      if (!state) {
        encounterTitle.textContent = 'No active session';
        battle.textContent = 'Join a room to enter the realm.';
        return;
      }

      if (!state.enemy) {
        encounterTitle.textContent = `Room ${state.room} Â· Encounter ${state.encounter}`;
        battle.innerHTML = '<strong>The enemy has been defeated.</strong><p>Any living player can start the next encounter.</p>';
        return;
      }

      encounterTitle.textContent = `Room ${state.room} Â· Encounter ${state.encounter}`;
      battle.innerHTML = `
        <h3>${state.enemy.name} ${state.enemy.boss ? 'ğŸ‘‘' : ''}</h3>
        <p>HP: <strong>${state.enemy.hp}/${state.enemy.maxHp}</strong></p>
        <p>Damage: ${state.enemy.attackMin}-${state.enemy.attackMax}</p>
      `;
    }

    function renderParty(state) {
      const party = ids('party');
      if (!state?.players?.length) {
        party.textContent = 'No party members.';
        return;
      }

      party.innerHTML = state.players.map((player) => {
        const isMe = player.id === playerId;
        return `<p class="entry"><strong>${player.name}</strong>${isMe ? ' (you)' : ''} Â· Lv ${player.level} Â· HP ${player.hp}/${player.maxHp} Â· Mana ${player.mana}/${player.maxMana} Â· Potions ${player.potions} Â· Gold ${player.gold} ${player.alive ? '' : 'ğŸ’€'}</p>`;
      }).join('');
    }

    function renderLog(state) {
      ids('log').innerHTML = (state.log || []).map((line) => `<p class="entry">${line}</p>`).join('');
    }

    function render(state) {
      currentState = state;
      renderBattle(state);
      renderParty(state);
      renderLog(state);
      setActionAvailability();
    }

    async function sendAction(action) {
      if (!playerId || !currentRoom) return;
      await fetch('/action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId, room: currentRoom, action })
      });
    }

    function connect() {
      const name = ids('nameInput').value.trim() || 'Adventurer';
      const room = ids('roomInput').value.trim() || 'global';

      if (eventSource) eventSource.close();

      const params = new URLSearchParams({ name, room });
      eventSource = new EventSource(`/events?${params.toString()}`);
      controls.join.disabled = true;

      eventSource.addEventListener('hello', (event) => {
        const hello = JSON.parse(event.data);
        playerId = hello.playerId;
        currentRoom = hello.room;
        ids('roomTag').textContent = currentRoom;
        setConnected(true);
      });

      eventSource.addEventListener('state', (event) => {
        render(JSON.parse(event.data));
      });

      eventSource.onerror = () => {
        setConnected(false);
        controls.join.disabled = false;
      };
    }

    controls.join.addEventListener('click', connect);
    controls.attack.addEventListener('click', () => sendAction('attack'));
    controls.spell.addEventListener('click', () => sendAction('spell'));
    controls.potion.addEventListener('click', () => sendAction('potion'));
    controls.rest.addEventListener('click', () => sendAction('rest'));
    controls.next.addEventListener('click', () => sendAction('next'));
  </script>
</body>
</html>
